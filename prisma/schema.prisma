// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

//////////////////// ENUMS ////////////////////

enum Status {
  ACTIVE
  INACTIVE
}

enum LegPosition {
  LEFT
  RIGHT
}

enum KycStatus {
  PENDING
  APPROVED
  REJECT
}

enum AdminType {
  SUPERADMIN
  ADMIN
  MANAGER
}

//////////////////// ADMIN ////////////////////

model Admin {
  id           Int       @id @default(autoincrement()) @map("admin_id")
  firstName    String?   @map("admin_fname") @db.VarChar(50)
  lastName     String?   @map("admin_lname") @db.VarChar(50)
  mobileOne    String?   @map("mob_one") @db.VarChar(20)
  mobileTwo    String?   @map("mob_two") @db.VarChar(20)
  email        String?   @unique @map("email_id") @db.VarChar(100)
  pinCode      String?   @map("pinno") @db.VarChar(20)
  country      String?   @map("country_name") @db.VarChar(100)
  state        String?   @map("state_name") @db.VarChar(100)
  address      String?   @db.Text
  username     String    @unique @map("admin_username") @db.VarChar(30)
  password     String    @map("admin_password") @db.VarChar(255)
  profileImage String?   @map("profile_img") @db.Text
  adminType    AdminType @map("admin_type")
  accessToken  String?   @map("access_token") @db.Text
  refreshToken String?   @map("refresh_token") @db.Text
  status       Status    @default(ACTIVE)

  createdAt DateTime @default(now()) @map("insert_date")
  createdBy String?  @map("insert_user") @db.VarChar(50)
  updatedAt DateTime @updatedAt @map("update_date")
  updatedBy String?  @map("update_user") @db.VarChar(50)

  // USER audit
  createdUsers User[] @relation("AdminCreatedUsers")
  updatedUsers User[] @relation("AdminUpdatedUsers")

  // KYC audit
  createdKycs  Kyc[] @relation("AdminCreatedKyc")
  updatedKycs  Kyc[] @relation("AdminUpdatedKyc")
  approvedKycs Kyc[] @relation("AdminApprovedKyc")

  // PACKAGE audit
  createdPackages Packages[] @relation("AdminCreatedPackages")
  updatedPackages Packages[] @relation("AdminUpdatedPackages")

  // Logs
  loginHistory     AdminLoginHistory[] @relation("AdminLoginHistoryRelation")
  activityLogs     AdminActivityLog[]  @relation("AdminActivityLogs")
  userActivityLogs UserActivityLog[]   @relation("AdminUserActivityLogs")

  @@map("aa_0_admin_db")
}


model User {
  id        Int    @id @default(autoincrement())
  firstName String
  lastName  String
  mobile    String @unique
  email     String @unique
  password  String

  sponsorId   Int? 
  parentId    Int?
  memberId    String? @unique
  legPosition LegPosition?

  leftChildId  Int?
  rightChildId Int?
  lastLeftId   Int?
  lastRightId  Int?

  lineagePath String
  directCount Int @default(0)

  kycStatus KycStatus @default(PENDING)
  status    Status    @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?


  sponsor        User?  @relation("SponsorRelation", fields: [sponsorId], references: [id])
  sponsoredUsers User[] @relation("SponsorRelation")

  parent   User?  @relation("ParentRelation", fields: [parentId], references: [id])
  children User[] @relation("ParentRelation")

  leftChild    User?  @relation("LeftChildRelation", fields: [leftChildId], references: [id])
  leftChildren User[] @relation("LeftChildRelation")

  rightChild    User?  @relation("RightChildRelation", fields: [rightChildId], references: [id])
  rightChildren User[] @relation("RightChildRelation")

  lastLeft      User?  @relation("LastLeftRelation", fields: [lastLeftId], references: [id])
  lastLeftUsers User[] @relation("LastLeftRelation")

  lastRight      User?  @relation("LastRightRelation", fields: [lastRightId], references: [id])
  lastRightUsers User[] @relation("LastRightRelation")


  createdByAdminId Int?
  updatedByAdminId Int?

  createdByAdmin Admin? @relation("AdminCreatedUsers", fields: [createdByAdminId], references: [id])
  updatedByAdmin Admin? @relation("AdminUpdatedUsers", fields: [updatedByAdminId], references: [id])

 

  kyc              Kyc?
  userActivities   UserActivityLog[]

  @@index([lineagePath])
  @@map("users")
}



model Kyc {
  id      Int @id @default(autoincrement())
  userId  Int @unique

  aadharNo        String
  aadharImgUrl    String
  panNo           String
  panImageUrl     String
  bankName        String
  accountNo       String
  ifscCode        String
  branchName      String
  bankProofImgUrl String

  status       KycStatus @default(PENDING)
  rejectReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  user User @relation(fields: [userId], references: [id])

  createdByAdminId  Int?
  updatedByAdminId  Int?
  approvedByAdminId Int?

  createdByAdmin  Admin? @relation("AdminCreatedKyc", fields: [createdByAdminId], references: [id])
  updatedByAdmin  Admin? @relation("AdminUpdatedKyc", fields: [updatedByAdminId], references: [id])
  approvedByAdmin Admin? @relation("AdminApprovedKyc", fields: [approvedByAdminId], references: [id])

  @@map("kyc")
}



model Packages {
  id                 String @id @default(uuid())
  packageName        String
  price              Float
  BV                 Float
  dailyCap           Float
  coinsPerMonth      Float
  packageDescription String
  status             Status @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  createdByAdminId Int?
  updatedByAdminId Int?

  createdByAdmin Admin? @relation("AdminCreatedPackages", fields: [createdByAdminId], references: [id])
  updatedByAdmin Admin? @relation("AdminUpdatedPackages", fields: [updatedByAdminId], references: [id])

  @@map("packages")
}



model UserActivityLog {
  id        Int      @id @default(autoincrement())
  userId    Int?
  adminId   Int
  action    String   @db.VarChar(50)
  details   String?  @db.Text
  createdAt DateTime @default(now())

  user  User?  @relation(fields: [userId], references: [id], onDelete: SetNull)
  admin Admin  @relation("AdminUserActivityLogs", fields: [adminId], references: [id])

  @@map("user_activity_logs")
}

model AdminActivityLog {
  id        Int      @id @default(autoincrement())
  adminId   Int
  action    String
  entity    String
  entityId  String
  oldData   Json?
  newData   Json?
  meta      Json?
  createdAt DateTime @default(now())

  admin Admin @relation("AdminActivityLogs", fields: [adminId], references: [id])
}

model AdminLoginHistory {
  id         Int      @id @default(autoincrement())
  adminId    Int
  ipAddress  String?
  userAgent  String?
  loginTime  DateTime @default(now())
  logoutTime DateTime?

  admin Admin @relation("AdminLoginHistoryRelation", fields: [adminId], references: [id])

  @@map("admin_login_history")
}
